name: Publish to PlatformIO Registry

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string
      version_tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  publish-to-platformio:
    name: Publish to PlatformIO Registry
    runs-on: ubuntu-latest

    environment:
      name: platformio
      url: https://registry.platformio.org/libraries/the78mole/BThomeV2

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install PlatformIO and Jinja2
      run: |
        pip install --upgrade platformio jinja2

    - name: Generate library files from templates
      run: |
        python3 << 'EOF'
        import jinja2
        import sys

        version = "${{ inputs.version }}"

        # Render library.json
        with open('library.json.j2', 'r') as f:
            template = jinja2.Template(f.read())
        with open('library.json', 'w') as f:
            f.write(template.render(version=version))

        # Render library.properties
        with open('library.properties.j2', 'r') as f:
            template = jinja2.Template(f.read())
        with open('library.properties', 'w') as f:
            f.write(template.render(version=version))

        print(f"âœ… Generated library.json and library.properties with version {version}")
        print("Note: Files generated temporarily for publishing, not committed to repo")
        EOF

    - name: Publish to PlatformIO
      env:
        PLATFORMIO_AUTH_TOKEN: ${{ secrets.PLATFORMIO_AUTH_TOKEN }}
      run: |
        # Publish to PlatformIO Registry
        # The registry will index the repository and use the git tag
        # Library metadata files are generated with correct version but not committed
        pio pkg publish --owner the78mole --non-interactive

        echo "âœ… Published to PlatformIO Registry"

    - name: Add PlatformIO Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY <<EOF
        ## ðŸ“¦ PlatformIO Registry VerÃ¶ffentlichung

        **Package:** [BThomeV2](https://registry.platformio.org/libraries/the78mole/BThomeV2)
        **Version:** \`${{ inputs.version }}\`
        **Git Tag:** \`${{ inputs.version_tag }}\`

        ### Installation

        \`\`\`ini
        [env:myenv]
        lib_deps =
            the78mole/BThomeV2@^${{ inputs.version }}
        \`\`\`

        Die Library wird innerhalb von 24 Stunden im PlatformIO Registry-Index verfÃ¼gbar sein.
        EOF
